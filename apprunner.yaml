version: 1.0
runtime: python311

build:
  commands:
    pre-build:
      - echo "Installing system dependencies..."
      - yum groupinstall -y "Development Tools"
      - yum install -y postgresql-devel
    build:
      - echo "Upgrading pip..."
      - python3 -m pip install --upgrade pip setuptools wheel
      - echo "Installing cmdstanpy first..."
      - python3 -m pip install --no-cache-dir cmdstanpy==1.2.0
      - echo "Installing remaining dependencies..."
      - python3 -m pip install --no-cache-dir -r requirements.txt
      - echo "Installing CmdStan compiler..."
      - python3 -c "import cmdstanpy; cmdstanpy.install_cmdstan(cores=2, verbose=True)"

run:
  command: uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1
  network:
    port: 8000
  env:
    - name: PYTHONPATH
      value: /app
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: MALLOC_TRIM_THRESHOLD_
      value: "100000"
    - name: CMDSTAN
      value: /root/.cmdstan